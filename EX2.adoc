[[課題2_ビルトインスロットを使おう]]
= [課題2] ビルトインスロットを使おう
:imagesdir: ./images

[[課題2のゴール]]
== 課題2のゴール

課題2では *コーヒーの数* を受け取るようにスキルを改良します。

この課題で学んだテクニックを使うと次のようなことができるようになります。

* 対話モデルのサンプル発話にスロットを導入する手順を実演できる
* 標準スロットタイプの種類を選択することができる。
* スロットで受け取ったデータがどのようにエンドポイントに渡されるかを説明できる。

[[課題2で作る対話モデル]]
== 課題2で作る対話モデル
.課題2の会話サンプル
====
image:icons/user_speak.jpg[width="40"]「アレクサ、コーヒーショップを開いて、コーヒーを2つください」

image:icons/alexa_icon.jpg[width="40"] 「コーヒーを**2つ**ですね、ありがとうございます。今日は天気がいいので全部100円でいいですよ。またのご利用をお待ちしております。」
====

[TIP]
====
* サンプル発話に「スロット」を追加し、エンドポイントでインテントと共にスロットの数字を受け取れるようにします。
====

.参考ドキュメント
[NOTE]
====
* https://developer.amazon.com/ja/docs/custom-skills/create-intents-utterances-and-slots.html[インテント、発話、スロットの作成]
* https://developer.amazon.com/ja/docs/custom-skills/slot-type-reference.html[スロットタイプリファレンス]
====

image:icons/alexa_dojo.png[width="40"]  https://alexa.design/jp-alexadojo005[第5回 Alexa道場：スロットを使って発話内の可変文字列を取得しよう]

[[スロットを追加する]]
=== スロットを追加する
. 開発者コンソールに戻りスキルビルダーを開きます。
. インテント「*OrderIntent*」をクリックして、スロットを含むサンプル発話を追加します。まず「コーヒーを一つください」と入力してみましょう。
+
image::EX2/OrderIntent.png[]
+
. スロットにしたい部分、この場合だと「一」（漢数字の1）の部分をマウスで選択します。下図のようなスロットを追加するポップアップが表示されます。
+
image::EX2/Add_New_Slot.png[]
+
. 新しいスロットを作成のテキストフィールドに、追加したいスロット名「amount」を入力しましょう。スロット名は必ず半角英文字で入力します。入力したら「追加」ボタンをクリックします。
+
image::EX2/Add_Amount_Slot.png[]
+
. スロットを含むサンプル発話に置き換えられています。＋ボタンか、リターンキーを押して確定します。
+
image::EX2/Amount_Slot.png[]
+
. 画面の下の方を見ると、インテントスロットにamountが追加されていることが確認できます。amountのスロットタイプを設定しましょう。この場合「数値」を取得するので、標準スロットタイプのAMAZON.NUMBERを選択します。
+
image::EX2/SlotType_AMAZON_Number.png[]
+
. 次にもう一つ同じスロットamountを含むサンプル発話を追加します。「コーヒーを一つ注文して」と入力し、同じように漢字の「一」を選択します。今度は、既存のスロットを選択にamountが表示されるので、これを選択しクリックします。
+
image::EX2/Existing_Slot.png[]
+
. サンプル発話の入力中に、スロットを挿入したい部分でキーボードの *{* をタイプしてもスロット選択のポップアップが表示されます。好みの方法で、スロットを含むサンプル発話をどんどん追加してください。
+
image::EX2/Select_Slot.png[]
+
. 充分な数のサンプル発話が追加できたら「モデルを保存」し「モデルをビルド」をクリックしてください。
+
image::EX2/Save_and_Build.png[]

[NOTE]
====
「〜つ」、「〜個」や「〜杯」など数の数え方の単位も含め、あらゆるパターンを追加しましょう。ある程度はAlexaが自動で認識するようですが、何度ものテストを繰り返して満足できる認識結果が得られるまで調整しましょう。
====

[[課題2_Lambdaのコードを改良する]]
== Lambdaのコードを改良する

次に、スロットの値を受け取れるようにLambda側のプログラムコードも修正しましょう。

プログラミングに自信のない方は、Lambdaの *indes.js* をサンプルファイル <<Sample2.js>> の中身をコピーして貼り付けてください。

image::EX2/Sample2_JS.png[]

自分でコードを書いてみたい方は、以下のコードをヒントに、既存のコードに修正を加えてください。

.スロット amount の値を取得し、amountの値を含めた応答を返すコード (node.js)
[source,javascript,linenums]
----
var amount = handlerInput.requestEnvelope.request.intent.slots.amount.value;

const speechOutput = 'コーヒーを' + amount + 'つですね、ありがとうございます。今日は天気がいいので全部100円でいいですよ。またの御利用をお待ちしております。';

return handlerInput.responseBuilder
.speak(speechOutput)
.getResponse();
----

Lambda関数のコードの修正が完了したら「保存」ボタンをクリックしてテストしましょう。

[[テスト2]]
== テストする

対話モデル及びLambda関数の修正が終わったらスロットの値が正しく取得できるかどうかテストしましょう。

. Alexaシミュレータを開き、「`コーヒーショップを開いて、コーヒーを一つ注文して`」のようにスロットを含めた発話を入力してテストしてみましょう。このとき、スロットに数字を入れる場合は、漢数字で入れてください。半角や全角の数字はうまく認識しないので注意してください。
+
image::EX2/Sample_Utterances.png[]
+
. JSON入力で、スロットの値が正しく取得できているかどうかを観察します。下図のようにスロット名 *amount* に数字（下図の場合は1）が入ります。
+
image::EX2/JSON_Input.png[]
+
. JSON出力側も正しく数字の入った応答を返しているかを確認しましょう。
