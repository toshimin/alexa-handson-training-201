= 発話のバリエーション
:imagesdir: ./images

== この実習の学習目標

この実習では、ユーザーの様々な発話パターンをAlexaが正しく認識できるように改良するテクニックを学びます。

この実習で学んだテクニックを使うと次のようなことができるようになります。

* 対話モデルのインテントに適切な数のサンプル発話を追加して、ユーザーの発話の認識率を向上させることができる。
* スロットに同義語（シノニム）を追加して、同じ意味をもつ別の言い方にも対応できるように改良できる。

== 対話モデルの編集
.スキルの会話サンプル
====
image:icons/user_speak.jpg[width="40"]「アレクサ、コーヒーショップで、**冷たいコーヒー**を**一**つ頼む」

image:icons/alexa_icon.jpg[width="40"] 「**冷たいコーヒー**を**1つ**ですね。ありがとうございます。今日は天気がいいので全部100円でいいですよ。またの御利用をお待ちしております。」
====

====
image:icons/user_speak.jpg[width="40"]「アレクサ、コーヒーショップを開いて、**カフェラテ**をください」

image:icons/alexa_icon.jpg[width="40"] 「**カフェラテ**ですね。ありがとうございます。今日は天気がいいので全部100円でいいですよ。またの御利用をお待ちしております。」
====

.参考ドキュメント
[NOTE]
====
* https://developer.amazon.com/ja/docs/custom-skills/create-intents-utterances-and-slots.html[インテント、発話、スロットの作成]
* https://developer.amazon.com/ja/docs/custom-skills/define-synonyms-and-ids-for-slot-type-values-entity-resolution.html[スロットタイプ値の同義語とIDを定義する（エンティティ解決）]
====

=== インテントのサンプル発話を追加する

インテントに対するユーザーの発話パターンは一つとは限りません。同じ内容のことを話す場合でも、人によって様々な言い回しをします。住む地域によっては方言もあるでしょう。これら発話の多様性に対応できるようスキルを改良しましょう。

. 開発者コンソールのスキルビルダーを開きます。
. インテント「*OrderIntent*」をクリックして、サンプル発話を追加します。言葉の揺れ、異なる言い回し、方言なども考慮すると良いでしょう。また、全てのスロットが含まれる場合、一部のスロットしか含まれない場合、スロットが全く含まれない場合、スロットの順番が異なる場合など、あらゆる発話パターンを想定し、できるだけ多く入力します。
+
[NOTE]
サンプル発話に入力したフレーズは、Alexaの機械学習の教師データとして登録されます。サンプル発話の数が多ければ多いほど、認識率が向上します。

+
image::EX4/Add_OrderIntent_SampleUtterances.png[]
+
. 同様に、インテント「*RecommendIntent*」をクリックして、サンプル発話を追加します。
+
. 対話モデルを修正したら対話モデルを保存し、ビルドします。
+
. AlexaシミュレーターまたはAlexa対応デバイスでテストをします。

[[シノニムを追加する]]
=== 同義語（シノニム）を追加する

同じ意味を持つ言葉でも様々なフレーズを使います。例えば「アイスコーヒー」のことを「冷たいコーヒー」という人もいるでしょう。「カフェオレ」という人もいれば「カフェオーレ」という人もいるでしょう。こうした言葉の揺れはスロット値の取得に影響を及ぼします。異なるフレーズでも同じスロット値として取り扱いたい場合には、シノニムの機能を使うと便利です。

ここでは、既に登録済みの *MenuList* スロットタイプの各値にシノニムを追加しましょう。

. 開発者コンソールのスキルビルダーを開きます。
. 左パネルの「スロットタイプ」から *MenuList* をクリックします。
. 既に登録されているドリンクメニューの名前に対し、それぞれ別の言い回しを追加します。
. プログラムコードで処理しやすいように各スロット値に固有のIdを付与することもできます。Idは任意で入力します。
. 対話モデルを修正したら対話モデルを保存し、ビルドします。
. AlexaシミュレーターまたはAlexa対応デバイスでテストをします。
+
image::EX4/Add_Synonyms.png[]

== Lambdaのコードを改良する

[NOTE]
プログラミングに自信のない方は、Lambdaの *index.js* のコードをサンプルファイル <<Sample4.js>> のコードに置き換えてください。

=== スロット値の有無によって応答を変える

例えば *OrderIntent* に注目した場合、ユーザーは必ずしもメニューと個数を言ってくれるとは限りません。もし発話の中でスロット値が提供されなかった場合、リクエストデータにはそのスロット値は含まれず、Node.js のスロット変数の値は `undefined` となります。

コードの中ではこのような場合のエラー処理も考慮する必要があります。例えば下のようにコードを修正します。

[source,javascript]
.スロット値の有無によって応答を変えるコードの例
const OrderIntentHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === 'IntentRequest'
            && handlerInput.requestEnvelope.request.intent.name === 'OrderIntent';
    },
    handle(handlerInput) {
        var amount = handlerInput.requestEnvelope.request.intent.slots.amount.value;
        var menu = handlerInput.requestEnvelope.request.intent.slots.menu.value;
        if (menu == undefined){
          // ユーザーがメニューを言わなかった場合
            const speechOutput = 'コーヒー、カフェラテ、カプチーノからお選びいただけます。どれにしますか？';
            const reprompt = '何にしますか？';
            return handlerInput.responseBuilder
            .speak(speechOutput)
            .reprompt(reprompt)
            .getResponse();
        } else if(amount === undefined){
            // ユーザーが数量を言わなかった場合
            const speechOutput = menu + 'ですね。ありがとうございます。今日は天気がいいので全部100円でいいですよ。またの御利用をお待ちしております。';
            return handlerInput.responseBuilder
            .speak(speechOutput)
            .getResponse();
        } else {
            // ユーザーがメニューと数量の両方を言った場合
            const speechOutput = menu + 'を' + amount + 'つですね、ありがとうございます。今日は天気がいいので全部100円でいいですよ。またの御利用をお待ちしております。';
            return handlerInput.responseBuilder
            .speak(speechOutput)
            .getResponse();
        }
    }
};

=== 同義語に含まれるフレーズかどうかを確認する（エンティティ解決）

ユーザーが話したスロット値が、同義語に含まれるフレーズかそうではないかは、`slots` データに含まれるステータスコード `<slot名>.resolutions.resolutionsPerAuthority[].status.code` の値を調べることで判別できます。

ステータスコードの意味は、次の通りです。

- ユーザーの値がカスタム値または同義語の1つに一致した場合、ステータスコードは**ER_SUCCESS_MATCH**になります。
- ユーザーの値がそれ以外の値（そのタイプのビルトインデータなど）に一致した場合、ステータスコードは**ER_SUCCESS_NO_MATCH**になります。

ステータスコードを調べ、同義語に含まれる場合、そのスロット値の代表値で応答を返すサンプルコードは以下のようになります。お好みでLambdaコードに組み込んでください。

[source,javascript]
.同義語に含まれる場合は、その代表値で応答を返すコードの例
 // ステータスコードを取得する
let status = handlerInput.requestEnvelope.request.intent.slots.menu.resolutions.resolutionsPerAuthority[0].status.code;
if (status === "ER_SUCCESS_MATCH"){
    // ステータスコードを調べて、MATCHだったら代表値を取得してmenuにセットする
    menu = handlerInput.requestEnvelope.request.intent.slots.menu.resolutions.resolutionsPerAuthority[0].values[0].value.name;
}

== テストする

対話モデル及びLambda関数の修正が終わったら、あらゆるユーザーの発話のバリエーションでも正しくスキルが動作するかどうかテストしましょう。

. Alexaシミュレータを開き、様々な発話のバリエーションを試してください。テキストのタイプ入力だけでなく、音声入力でも試してください。
+
.様々な発話のバリエーションでテストする
image::EX4/Test_VariousUtterances.png[]
+
. カスタムスロットタイプのリストに含まれるメニューを言った場合と、含まれないメニューを言った場合のJSONデータの違いを確認してください。
+
.カスタムスロットタイプの同義語に含まれる場合
image::EX4/Review_JSON_IO.png[]
+
.カスタムスロットタイプの同義語に含まれない場合
image::EX4/Review_JSON_IO2.png[]
