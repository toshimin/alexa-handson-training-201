= 初めて作るカスタムスキル
:imagesdir: ./images

この実習ではシンプルなカスタムスキル *「コーヒーショップ」* を作成します。現在のところスキル内で代金を支払う機能を設けることはできませんので、注文した商品を店頭にて作り置きを依頼するためのスキルであると想定して下さい。

== この実習の学習目標

この実習で学んだテクニックを使うと次のようなことができるようになります。

* スキルビルダーを使って対話モデルを作成することができる。
* AWS LambdaとASK SDKを使ってエンドポイントのプログラムを作成できる。
* Alexa シミュレーターを使って作成したスキルをテストできる。

.スキルの会話サンプル
====
image:icons/user_speak.jpg[width="40"]「アレクサ, コーヒーショップを開いてコーヒーを注文して」

image:icons/alexa_icon.jpg[width="40"] 「コーヒーですね、ありがとうございます。今日は天気がいいので全部100円でいいですよ。またのご利用をお待ちしております。」
====

[TIP]
====
* 「呼び出し名」の意味と使い方を理解しよう
* 「インテント」と「サンプル発話」を適切に設計しよう
====

<<<
== 対話モデルのデザイン

このセクションでは最初のステップ、対話モデルのデザインを行います。ユーザーがAlexaに対して何か話したら、Alexaがそれをどのように理解し、どのようなデータをエンドポイント（開発者のプログラムが動作するサーバー）に送るのかを設計します。

image::EX1/Dev_Process_Step1.png[]

image:icons/alexa_dojo.png[width="40"]  https://alexa.design/jp-alexadojo003[第3回 Alexa道場：音声インターフェイスをデザインしよう]

[TIP]
このセクションでは、開発者コンソールを使用します。

.参考ドキュメント
[NOTE]
====
* https://developer.amazon.com/ja/docs/custom-skills/steps-to-build-a-custom-skill.html[カスタムスキルの構築手順]
====

=== 開発者コンソールへのログイン

. Webブラウザ (Firefox または Chrome )で開発者コンソールへアクセスします。 +
https://developer.amazon.com/ja/[https://developer.amazon.com/ja/]
. 「Developer Console」のリンクをクリックします。
+
image::EX1/DevConsole.jpg[]
. ログインページが表示されたら、お手持ちのAmazon.co.jpアカウントでログインします。
+
image::EX1/DevConsole_Login.png[]
+
[NOTE]
====
* 初めて開発者アカウントを作成する場合でも、ログインするだけで自動的に登録画面に遷移します。Echoデバイスをお持ちの方は、そのデバイスをセットアップした時に使用したアカウントをお使いください。作成したスキルをお手持ちのデバイスでもテストできるので便利です。
* Amazon.co.jp (日本)と Amazon.com (米国) アカウントの両方をお持ちの方は、それぞれ異なるパスワードを設定し、Amazon.co.jp のアカウントでログインする必要があります。もし同じパスワードを設定している場合は、自動的に Amazon.com のアカウントでUSのスキルを開発することになるのでご注意ください。
* よくわからない場合はサポートスタッフにお声がけください。
====
+
. 初めてログインした場合、開発者アカウントの登録画面が表示されます。必要事項を入力してください。
+
[WARNING]
====
この画面が表示されなかった場合、または英語のインターフェースで表示されてしまった場合は近くのサポートスタッフにお声がけください。
====
+
image::EX1/DevAccount_Profiles.jpg[]
. 利用規約に同意します。
+
image::EX1/DevAccount_Agreements.jpg[]
. 収益化についての質問に答えて「保存して続行」ボタンをクリックしてください。今回は全て「いいえ」を選択します。
+
image::EX1/DevAccount_Payment.jpg[]
. 開発者コンソールのTOP画面が表示されると開発者アカウントが正しく作成されています。
+
image::EX1/Developer_Console.png[]

<<<
=== スキルの新規作成

. 「Alexa」メニューから「Alexa Skills Kit」をクリックします。
+
image::EX1/TAB_Alexa_Skills_Kit.png[]
+
. 「スキル名」の入力とスキルのデフォルト言語を選択します。
スキル名とは、このスキルを公開した際、スキルストアに表示されるスキルの名称です。ここではスキル名を *「コーヒーショップ」* 、スキル作成時のデフォルトは *「日本語」* を選択します。 +
「スキルに追加するモデルの選択」では「カスタム」を選択し「スキルを作成」ボタンをクリックします。
+
image::EX1/Create_Skill_Button.png[]
+
. スキルビルダーの画面が表示されます。 +
右側のチェックリストは、この画面では4つの作業ステップあり、全てのステップをクリアすると、次のステップの「テスト」へ進めることを表しています。 +
チェックリストの手順に従い、「1.呼び出し名」のボックスをクリックします。
[NOTE]
左側パネルの「カスタム」をクリックするといつでもこの画面に戻ることができます。

+
image::EX1/Skill_Builder.png[]
+
. スキルの呼び出し名を入力します。 +
このスキルを起動するための呼び出す名を設定します。呼び出し名は2〜50文字である必要があります。ここでは「コーヒーショップ」と入力し「モデルを保存」をクリックします。
[NOTE]
これで、ユーザーは「アレクサ、コーヒーショップを開いて、◯◯して。」のようにスキルを起動してスキルと会話できるようになります。

+
image::EX1/Invocation_Name.png[]
+
[TIP]
====
画面下の「呼び出し名の要件」は必ず読むようにしてください。使用できない文字や単語などの重要な情報が記載されています。
====
+
.参考ドキュメント
[NOTE]
====
* https://developer.amazon.com/ja/docs/custom-skills/steps-to-build-a-custom-skill.html[ユーザーによるカスタムスキルの呼び出し] +
* https://developer.amazon.com/ja/docs/custom-skills/choose-the-invocation-name-for-a-custom-skill.html[カスタムスキルの呼び出し名を決定する]
====
+
. 左パネルの「カスタム」をクリックし元の画面に戻ります。
. スキルビルダーのチェックリストの「1.呼び出し名」に緑のチェックが付いていることを確認します。
+
image::EX1/Confirm_InvovationName.png[]

<<<
=== 対話モデルの作成

対話モデルのデザインに取りかかります。ここでは、ユーザーがどのように発話すれば、どのようにAlexaがその意味を解釈し、その結果をどのようにイベントとしてエンドポイントのサーバーに伝えるべきかをデザインします。これらの入力データは「ビルド」という作業を経てAlexaの学習データとして取り込まれます。

. スキルビルダーのチェックリストの「2.インテント、サンプル、スロット」のボックスをクリックします。
+
[NOTE]
左パネルの「インテント」の右にある「追加」ボタンをクリックしても同じ画面に遷移します。

+
image::EX1/Add_Intent.png[]
. カスタムインテントの名前を入力します。ここでは *OrderIntent* と半角英文字で入力し「カスタムインテントを作成」ボタンをクリックします。
+
image::EX1/Create_Custom_Intent.png[]
+
[NOTE]
====
OrderIntent のスペルは間違えないよう正確に入力してください。これを間違えると、エンドポイント側で正しい名前のインテントを取得できずエラーになります。
====
+
. インテント *OrderIntent* に紐づくサンプル発話を入力します。サンプル発話とは、インテントを呼び出すためにユーザーがAlexaに話しかけるフレーズのことです。 +
ここでは、コーヒーショップのスキルを使ってコーヒーを注文するためのフレーズ「コーヒーを注文して」と入力します。
+
image::EX1/Sample_Utterrances.png[]
+
. インテントのサンプル発話の入力が完了したら「モデルを保存」をクリックし、最後に「モデルをビルド」ボタンをクリックします。モデルのビルドには1〜2分かかる場合があります。
+
image::EX1/Build_Model.png[]
+
. モデルのビルドが完了したら対話モデルの構築は完了です。左側の「カスタム」タブをクリックします。「ビルド」のトップ画面に戻り、スキルビルダーのチェックリストを確認しましょう。「3. モデルをビルド」まで完了し緑のチェックマークがついていればOKです。
+
image::EX1/SkillBuilder_CheckList.png[]
+
. *「4. エンドポイント」* のボックスをクリックします。
+
image::EX1/EndPointBox.png[]
+
. サービスのエンドポイントの種類では「AWS LambdaのARN」を選択します。
+
image::EX1/AWS_Lambda_ARN.png[]
+
. 「クリップボードにコピー」のリンクをクリックし、スキルIDの文字列をコピーしておきます。この後の処理で必要となりますので、テキストエディタ等を開いてこの文字列を保存しておいてください。
+
image::EX1/Copy_Skill_ID.png[]

以上で、対話モデルの作業は終了です。ここまでの作業で、Alexaはユーザーの「コーヒーを注文して」という要求フレーズを理解し、エンドポイントのプログラムに *OrderIntent* というリクエストを送信できるようになります。

次に、リクエスト *OrderIntent* を受け取る側、つまりエンドポイントのプログラムを書くステップに移ります。

<<<
== エンドポイントの開発

image::EX1/Dev_Process_Step2.png[]

*OrderIntent* を受け取り、何らかの処理をした後、Alexaに応答を返すイベント駆動のサーバープログラムを作成します。サーバーのプラットフォームには、AWSのLambdaというサービスを利用します。スキルのプログラムコードは、Alexaスキル開発用のライブラリ  https://github.com/alexa/alexa-skills-kit-sdk-for-nodejs[Alexa Skills Kit SDK for Node.js] を使って作成します。

// V2に更新されるまでは削除
//image:icons/alexa_dojo.png[width="40"]  https://alexa.design/jp-alexadojo004[ 第4回 Alexa道場：Node jsを使ってAlexaスキルを作ろう]

[TIP]
このセクションでは、AWSマネージドコンソールを使用します。

.参考ドキュメント
[NOTE]
====
* https://developer.amazon.com/ja/docs/custom-skills/host-a-custom-skill-as-an-aws-lambda-function.html[カスタムスキルのAWS Lambda関数を作成する]
* https://developer.amazon.com/ja/docs/custom-skills/handle-requests-sent-by-alexa.html[Alexaから送信されたリクエストを処理する]
====

=== AWSコンソールへのログイン

. 以下のリンクからAWSポータルにアクセスします。
+
====
URL: https://aws.amazon.com/jp/[https://aws.amazon.com/jp/]
====
+
. 「コンソールへログイン」をクリックします。
+
image::EX1/AWS_TopPage.png[]
+
. AWSアカウントIDを入力します。
+
[CAUTION]
====
AWSアカウントは無料で作成できますが、クレジットカードの登録が必要になります。どうしてもアカウントの作成が難しい場合はサポートスタッフにご相談ください。
====
+
image::EX1/AWS_Signin_ID.jpg[]
. パスワードを入力し、ログインします。
+
[WARNING]
====
本来はセキュリティ上の理由からルートユーザーでのログインは推奨されません。通常はIAMで開発用ユーザーを追加し、開発用ユーザーでログインし直して作業を行ってください。
====
+
image::EX1/AWS_Signin_Password.jpg[]
+
. Lambdaを選択してクリックします。Lambdaが表示されていない場合は、上の検索ボックスに Lambda と入力すると表示されます。Lambdaはコンピューティングのカテゴリにあります。
+
image::EX1/Search_Lambda.png[]
+
. 右上のリージョンを**「アジアパシフィック（東京）」**に変更し、**「関数の作成」**ボタンをクリックしてください。
+
[WARNING]
====
2018年10月時点でAlexaに接続できるリージョンは、「米国東部(バージニア北部)」「米国西部(オレゴン)」「EU(アイルランド)」「アジアパシフィック(東京)」の４つとなっています。これ以外のリージョンでは、Alexaに接続できなくなるので注意してください。
====
+
image::EX1/Select_Tokyo_Region.png[]
+
. **「一から作成」**を選択し、名前欄に「*CoffeeShop*」と入力します。ランタイムのバージョンを「*Node.js 8.10*」に変更し、「ロール」のプルダウンメニューから「*テンプレートから新しいロールの作成*」を選択してください。ロール名には適当な名前をつけてください。（例：AlexaRole など）
+
image::EX1/Create_New_Function_From_Scratch.png[]
+
. ポリシーテンプレートは、「*シンプルなマイクロサービスのアクセス権限*」を選択してください。
+
[NOTE]
====
今回は Amazon CloudWatch Logsと Amazon DynamoDBにアクセスできるシンプルなロールテンプレートを選択します。S3など他のサービスにアクセスしたい場合は、適切なロールを追加してください。
====
+
image::EX1/Create_New_Role.png[]
+
. 下図のようになっていればOKです。画面下にある「*関数の作成*」ボタンをクリックしてください。
+
image::EX1/IAM_Role.png[]
+
. 関数が作成されると次のような画面になります。
+
image::EX1/Lambda_Function_Created.png[]

<<<
=== トリガーを追加する

Lambda関数は様々なサービスと接続し呼びだすことができます。トリガーとは、作成した関数が何によって呼び出されるかを指定します。ここでは *Alexa Skills Kit* を指定します。

. 画面左「トリガーの追加」から *Alexa Skills Kit* をクリックします。
+
image::EX1/Choose_ASK_Trigger.png[]
+
. *Alexa Skills Kit* が追加されると下のような表示になります。
+
image::EX1/Trigger_Setting.png[]
+
. トリガーの設定では、スキルIDを検証を「有効」に設定し、アプリケーションIDのテキスト入力フィールドに、<<対話モデルの作成>>のステップ7でコピーしておいたスキルIDを貼り付け、「追加」ボタンをクリックしてください。
+
[NOTE]
====
スキルIDの検証を「有効」にすることで、このLambda関数が、意図しない他のAlexaスキルから呼び出されないよう制限することができます。
====
+
image::EX1/Add_Application_ID.png[]
+
. 「保存」をクリックしてください。
+
image::EX1/Save_Trigger.png[]

=== Lambda関数のコードをアップロードする
. *Designer* パネルの中に表示されている「CoffeeShop」と書かれたLambdaのアイコンをクリックしてください。
+
image::EX1/Coffeeshop_Lambda.png[]
+
. 画面の下方に関数のコードエディタが表示されます。左上のコードエントリタイプのプルダウンメニューから「*.ZIPファイルをアップロード*」を選択してください。
+
image::EX1/Select_ZIP_File_Upload.png[]
+
. 「*アップロード*」ボタンをクリックしてください。
+
image::EX1/Upload_Button.png[]
+
. 解凍したサンプルファイルのフォルダの中から、*SampleCode1.zip* ファイルを探し選択してください。
+
image::EX1/Select_SampleCode1_ZIP_File.png[]
+
[NOTE]
====
ソースコードとライブラリを含めたZIPファイルの作り方は、以下のSK SDK v2 for Node.js のドキュメントを参照してください。
https://github.com/alexa/alexa-skills-kit-sdk-for-nodejs/wiki/%5BJapanese%5D-Setting-Up-The-ASK-SDK[Setting Up The ASK SDK]
====
+
. 画面右上の「*保存*」ボタンをクリックします。
+
image::EX1/Save_Button.png[]
+
. 課題1のサンプルコードが読み込まれた状態でコードエディタが開きます。ここでは *Sample1.js* のコードが *index.js* として読み込まれています。また、*ask-sdk-core* および *ask-sdk-model* のライブラリも同時にアップロードされていることが確認できます。
+
image::EX1/Sample1_Uploaded.png[]
+
. 画面右上に表示されている、ARNをクリップボードにコピーしておきます。
+
image::EX1/Copy_ARN.png[]
+
コピーする文字列は、以下のような形式になります。
+
----
arn:aws:lambda:ap-northeast-1:XXXXXXXXX:function:coffeeshop
----
+
これが、Alexa からLambda関数を呼び出すエンドポイントのアドレスになります。この文字列が間違っていると目的のエンドポイントが見つからない、または別のエンドポイントに接続され、エラーとなるので注意してください。

次のセクションでは、ステップ(1)で作成した対話モデルに、このセクションで作成したエンドポイントのLambda関数を登録します。

<<<
== エンドポイントを登録する

image::EX1/Dev_Process_Step3.png[]

対話モデルに、Lambda関数で作ったエンドポイントを登録し、Alexaから適切にLambda関数を呼び出せるようにします。

[TIP]
このセクションでは開発者コンソールを使用します。

1.  スキルビルダーの「カスタム」の画面に戻り、スキルビルダーのチェックリストから「4.エンドポイント」をクリックします。
+
[NOTE]
左パネルの「エンドポイント」をクリックしても同じです。

+
image::EX1/Menu_Endpoint.png[]
+
2.  サービスのエンドポイントをホスティングする方法は「AWS LambdaのARN」を選択します。「デフォルトの地域」のテキストボックスに先ほどコピーしておいたLambda関数のARNを貼り付けてください。その他の項目はデフォルトのままにしてください。
+
image::EX1/Default_Location.png[]
+
3.  「エンドポイントの保存」ボタンをクリックします。
+
image::EX1/Save_Endpoint.png[]

以上で、音声ユーザーインターフェースにエンドポイントを登録する作業が完了しました。簡単ですね？

これでスキルはほぼ完成に近づきました。次のステップでは、あなたのスキルが正しく動作するかテストしてみましょう。

<<<
== テストする

image::EX1/Dev_Process_Step4.png[]

この段階で、あなたのスキルはほぼ出来上がっています。正しく動作するかどうかテストしてみましょう。もしうまく動作しなかった場合は、どこかの設定が間違っているのかもしれません。ステップ(1)から(3)に戻り、再確認しましょう。
[TIP]
このセクションでは開発者コンソールを使用します。

.参考ドキュメント
[NOTE]
====
* https://developer.amazon.com/ja/docs/devconsole/test-your-skill.html[スキルのテスト]
* https://developer.amazon.com/ja/docs/custom-skills/understanding-how-users-invoke-custom-skills.html[ユーザーによるカスタムスキルの呼び出し]
====

=== Alexaシミュレータでテストする

. 「テスト」タブを開きます。テストが無効になっている場合はスイッチをクリックしてテストを有効に変更します。
+
image::EX1/Test_Switch.png[]
+
. Alexaシミュレータを使って、スキルのテストをしましょう。言語が日本語になっていることを確認し、その隣のテキストボックスにAlexaに話しかけるフレーズをテキストで入力し[Enter]キーを押します。
+
.入力例（ウェイクワードは省略することができます）
----
コーヒーショップを開いてコーヒーを注文して
----
+
もしくは下図のマイクのアイコンをクリックした状態で、同様のフレーズをパソコンのマイクに向かって声で話しかけます。
+
image::EX1/AlexaSimulator_MicButton.png[]
+
. 画面左側のパネルには、Alexaに送ったユーザーの発話と、Alexaからの応答メッセージが会話形式で表示されます。右側のパネルには、Alexa からスキルに送信されたJSONデータ (JSON入力) と、スキルからAlexaに送信されたJSONデータ (JSON出力) の中身を確認することができます。
+
image::EX1/Alexa_Simulator.png[]
+
. JSON入力の中から、どのようなインテントが送られてきているかを確認しましょう。
. JSON出力の中から `"outputSpeech":{"ssml": <speech> …` の文字列を探してみてください。レスポンスのJSONデータの中にAlexaが読み上げるテキストが埋め込まれていることがわかります。上部の右側の再生ボタンをクリックすると、Alexaが読み上げる音声を何度も再生することができます。

<<<
=== （オプション）Echoデバイスでテストする。

お手持ちのEchoデバイスを使ってテストする手順を説明します。はじめに、Alexaアプリのスキル一覧ページに開発中のスキルが表示されているかどうかを確認します。

[TIP]
ここではAlexaアプリを使用します。(https://alexa.amazon.co.jp)

[WARNING]
まだ１台も自分のアカウントでEchoデバイスをセットアップしたことがない場合、Alexaアプリにログインするとデバイスのセットアップ画面が表示され、自分のスキルを確認することはできません。

. Alexaアプリにログインし「スキル」タブをクリックします。
+
image::EX1/AlexaApp_Skills.png[]
+
. 「有効なスキル」をクリックします。
+
image::EX1/AlexaApp_ActiveSkills.png[]
+
. 「開発スキル」のタブをクリックします。
+
image::EX1/AlexaApp_DEV.png[]
+
現在開発中（非公開）のスキルのリストが表示されます。リストの中から、あなたが作成した「コーヒーショップ」スキルを探してください。アイコンの右下に緑色の *devJP* というマークのついたものが開発中のスキルを表しています。
+
image::EX1/Find_Coffeeshop_Skill.png[]
+
. スキルが有効になっていれば、開発者アカウントと同じアカウントでセットアップされているAlexa対応デバイス（Amazon Echoなど）でもテストすることができます。
+
image::EX1/AlexaApp_Coffeeshop_Skill.png[]
+
. もし、手元にAlexa対応デバイスがある場合は、それを使って動作テストをしてみてください。*スキルを起動する際は、スキルの呼び出し名を忘れずに！*
+
.呼び出しフレーズ
----
 アレクサ、コーヒーショップを開いてコーヒーを注文して」
----
+
image::EX1/echo_dot_main.jpg[]

スキル開発の基本ステップは以上です。初めて作成したスキルは動きましたか？

<<<
=== うまく動かない場合

うまく動かない場合、様々な要因がありますが特に以下の設定を見直してみましょう。

* スキルビルダーのチェックリストは全て緑のアイコンに変わっていますか？
* スキルビルダー側に登録したエンドポイントのARNは正しいですか？
* スキルビルダーで追加したインテント名のスペルと、Lambda関数で登録されているインテント名のスペルは一致していますか？
* Alexaシミュレーターで、音声を使ってスキルを起動した際の「呼び出し名」の認識文字列と、スキルビルダーで設定した「呼び出し名」は完全に一致していますか？

=== 「スキルからの応答に問題があります」？

Alexaが上記のフレーズを言って期待する動作をしない場合、Lambdaのコード内で何らかのエラーが発生し正しくレスポンスを返していない状態です。Lambda側で何が起きているのか *CloudWatchLog* を使ってエラーシューティングを行ってみましょう。

. Lambda関数の編集画面を開き、「モニタリング」をクリックします。
+
image::EX1/Monitoring_Tab.png[]
+
. CloudWatchメトリクスの画面が開きます。「呼び出しカウント」の枠内にある「ログにジャンプ」をクリックします。
+
image::EX1/Monitoring.png[]
+
. CloudWatchのログ画面が開きます。下に行くほど新しいログが表示されます。何らかのエラーが起こっている行を探します。フィルター機能を使って  *Error* 等の文字列で検索しても良いでしょう。
+
image::EX1/Error_Log.png[]
+
. エラーを見つけたら、メッセージを読みLambda関数内のエラー箇所を修正します。
. 修正したら再びAlexaシミュレーターでテストをしましょう。正しく動作するまでこのデバッグ作業を繰り返します。根気よく頑張りましょう！
