= スロットの使用
:imagesdir: ./images

== この実習の学習目標

この実習ではユーザーの発話から *ドリンクのメニュー* と *ドリンクの数* の情報を受け取るようにスキルを改良します。

この実習で学んだテクニックを使うと次のようなことができるようになります。

* 対話モデルのサンプル発話にスロットを導入する手順を実演できる
* 標準スロットタイプとカスタムスロットタイプを使い分けることができる。
* スロットで受け取ったデータがどのようにエンドポイントに渡されるかを説明できる。

== 対話モデルの編集
.スキルの会話サンプル
====
image:icons/user_speak.jpg[width="40"]「アレクサ、コーヒーショップを開いて、**カフェラテ**を**二つ**ください」

image:icons/alexa_icon.jpg[width="40"] 「**カフェラテ**を**2つ**ですね、ありがとうございます。今日は天気がいいので全部100円でいいですよ。またのご利用をお待ちしております。」
====

[TIP]
====
* サンプル発話に「スロット」を追加し、エンドポイントでインテントと共にスロットの値を受け取れるようにします。
====

.参考ドキュメント
[NOTE]
====
* https://developer.amazon.com/ja/docs/custom-skills/create-intents-utterances-and-slots.html[インテント、発話、スロットの作成]
* https://developer.amazon.com/ja/docs/custom-skills/slot-type-reference.html[スロットタイプリファレンス]
* https://developer.amazon.com/ja/docs/custom-skills/create-and-edit-custom-slot-types.html[カスタムスロットタイプの作成と編集]
====

image:icons/alexa_dojo.png[width="40"]  https://alexa.design/jp-alexadojo005[第5回 Alexa道場：スロットを使って発話内の可変文字列を取得しよう]

=== スロットを追加する
. 開発者コンソールに戻りスキルビルダーを開きます。
. インテント「*OrderIntent*」をクリックして、スロットを含むサンプル発話を追加します。まず「コーヒーを一つください」と入力してみましょう。
+
image::EX3/OrderIntent.png[]
+
. スロットにしたい部分「一」（漢数字の1）マウスで選択します。下図のようなスロットを追加するポップアップが表示されます。
+
image::EX3/Add_New_Slot.png[]
+
. 新しいスロットを作成のテキストフィールドに、追加したいスロット名「amount」を入力しましょう。スロット名は必ず半角英文字で入力します。入力したら「追加」ボタンをクリックします。
+
image::EX3/Add_Amount_Slot.png[]
+
. スロットを含むサンプル発話に置き換えられています。＋ボタンか、リターンキーを押して確定します。
+
image::EX3/Amount_Slot.png[]
+
. 画面の下の方を見ると、インテントスロットにamountが追加されていることが確認できます。amountのスロットタイプを設定しましょう。この場合「数値」を取得するので、標準スロットタイプのAMAZON.NUMBERを選択します。
+
image::EX3/SlotType_AMAZON_Number.png[]
+
. 次にもう一つ同じスロットamountを含むサンプル発話を追加します。「コーヒーを一つ注文して」と入力し、同じように漢字の「一」を選択します。今度は、既存のスロットを選択にamountが表示されるので、これを選択しクリックします。
+
image::EX3/Existing_Slot.png[]
+
. サンプル発話の入力中に、スロットを挿入したい部分でキーボードの *{* をタイプしてもスロット選択のポップアップが表示されます。好みの方法で、スロットを含むサンプル発話をどんどん追加してください。
+
image::EX3/Select_Slot.png[]
+
. 充分な数のサンプル発話が追加できたら「モデルを保存」し「モデルをビルド」をクリックしてください。
+
image::EX3/Save_and_Build.png[]

[NOTE]
====
「〜つ」、「〜個」や「〜杯」など数の数え方の単位も含め、あらゆるパターンを追加しましょう。ある程度はAlexaが補完して認識しますが、何度ものテストを繰り返して満足できる認識結果が得られるまで調整しましょう。
====

=== カスタムスロットタイプを追加する
. スキルビルダーを開き、左側のパネルからスロット値の「追加」ボタンをクリックします。
+
image::EX3/Slot_Data.png[]
+
. カスタムスロットタイプ名をMenuListにして、「カスタムスロットタイプを作成」ボタンをクリックします。
+
image::EX3/Create_Custom_SlotType.png[]
+
. スロット値を入力する画面が開きます。コーヒーショップで選択できるメニュー品目のリストを追加します。ここでは「コーヒー」「カフェオレ」「カプチーノ」「エスプレッソ」の4つを追加しましょう。追加が終わったら「モデルを保存」ボタンをクリックしておきます。
+
image::EX3/Save_Model.png[]
+
. インテント OrderIntentの編集画面を表示し、既に登録されているサンプル発話の「コーヒー」と書かれている部分をマウスで選択します。
+
image::EX3/Add_Menu_Slot.png[]
+
. 新しいスロットを作成のテキストフィールドに、追加するスロット名menuを入力し、「追加」ボタンをクリックします。
+
image::EX3/Name_SlotType.png[]
+
. 下方のインテントスロットを確認します。2行目を1クリックすると新しいスロットmenuが表示されます。スロットmenuのスロットタイプ MenuListをスロットタイプのリストから選択します。
+
image::EX3/Select_Menu_Slot.png[]
+
. 他の既存のサンプル発話の「コーヒー」の部分を全てスロットmenuに置き換えましょう。手順は同様で既存のスロットの選択リストにmenuが追加されているはずです。
+
image::EX3/Select_MenuList.png[]
+
. 全ての「コーヒー」をスロットmenuに置き換えたら、「モデルを保存」ボタンと「モデルをビルド」ボタンを順にクリックしましょう。
+
image::EX3/Save_And_Build2.png[]

以上で、対話モデルの修正は完了です。次にLambda関数の修正に移りましょう。

== Lambdaのコードを改良する

スロットmenuの値を受け取れるようにLambda側のプログラムコードも修正しましょう。

[NOTE]
プログラミングに自信のない方は、Lambdaの *index.js* のコードをサンプルファイル <<Sample3.js>> のコードに置き換えてください。自分でコードを書いてみたい方は、以下のコードをヒントに、既存のコードに修正を加えてください。

image::EX3/Sample3_JS.png[]

[source,javascript]
.スロット menu と amount の値を取得し、それぞれの値を含めた応答を返すコード
----
var amount = handlerInput.requestEnvelope.request.intent.slots.amount.value;
var menu = handlerInput.requestEnvelope.request.intent.slots.menu.value;

const speechOutput = menu + 'を' + amount + 'つですね、ありがとうございます。今日は天気がいいので全部100円でいいですよ。またの御利用をお待ちしております。';

return handlerInput.responseBuilder
.speak(speechOutput)
.getResponse();
----

CAUTION: ユーザーは欲しい品目を言ってくれない場合もあります。例えば「アレクサ、コーヒーショップで一つ注文して」のような場合です（このサンプル発話も追加しておく必要があります）。この場合、何を注文したいのかユーザーに聞き返す処理が必要で、そのコードは次のように書くことができます。この処理もコードに追加しておきましょう。

[source,javascript]
.ユーザーが欲しい商品を言ってくれなかった場合の判別と、ユーザーに尋ねるコード
----
if (menu === undefined){
    const speechOutput = 'コーヒー、カフェラテ、カプチーノからお選びいただけます。どれにしますか？';
    const reprompt = '何にしますか？';
    return handlerInput.responseBuilder
    .speak(speechOutput)
    .reprompt(reprompt)
    .getResponse();
}
----

Lambda関数のコードの修正が完了したら「保存」ボタンをクリックしてテストしましょう。

== テストする

対話モデル及びLambda関数の修正が終わったらスロットの値が正しく取得できるかどうかテストしましょう。

. Alexaシミュレータを開き、「`コーヒーショップを開いて、コーヒーを一つ注文して`」のようにスロットを含めた発話を入力してテストしてみましょう。このとき、スロットに数字を入れる場合は、漢数字で入れてください。半角や全角の数字はうまく認識しないので注意してください。タイプ入力だけではなく、音声入力でもテストを繰り返し、スロットの値が正しく取得できているかを確認しましょう。
+
image::EX3/Sample_Utterances.png[]
+
. JSON入力で、スロットの値が正しく取得できているかどうかを観察します。下図のようにスロット名 *menu* にユーザーが発話したメニューの名前（下図の場合は **コーヒー**）、 *amount* に数（下図の場合は数字の **2** ）が入ることを確認します。
+
image::EX3/JSON_Input_Slot_Menu_Amount.png[]
+
. JSON出力側も正しく数字の入った応答を返しているかを確認しましょう。
