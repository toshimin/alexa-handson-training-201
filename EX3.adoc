
[[課題3_カスタムスロットタイプを使おう]]
= [課題3] カスタムスロットタイプを使おう
:imagesdir: ./images

ここまでのコーヒーショップスキルでは、コーヒーしか注文できません。他のメニューも用意したいところですよね？　そこで、カスタムスロットタイプを追加して、コーヒー以外にも「カフェラテ」「カプチーノ」なども注文できるようにしましょう。

[[課題3のゴール]]
== 課題3のゴール

課題3ではカスタムスロットタイプを定義して任意のリストからスロットの値を取得します。

この課題で学習したテクニックを使うと、以下のことができるようになります。

* カスタムスロットタイプを定義することができる。
* カスタムスロットタイプが設定されたスロットをサンプル発話内に追加できる。
* カスタムスロットタイプのスロットから送られたデータをLambda関数内で取得できる。

.参考ドキュメント
[NOTE]
====
* https://developer.amazon.com/ja/docs/custom-skills/create-and-edit-custom-slot-types.html[カスタムスロットタイプの作成と編集]
====


[[課題3で作る対話モデル]]
== 課題3で作る対話モデル
.課題3の会話サンプル
====
image:icons/user_speak.jpg[width="40"]「アレクサ、コーヒーショップを開いて、**カフェラテ**を2つください」

image:icons/alexa_icon.jpg[width="40"] 「**カフェラテ**を2つですね、ありがとうございます。今日は天気がいいので・・・」
====
課題2の対話モデルとほぼ同じですが、商品をコーヒー、カフェラテ、カプチーノ、エスプレッソなどから選択できるようになっています。

まずは、スロットでメニュー品目を取得できるよう、カスタムスロットタイプを追加します。

[[カスタムスロットタイプを追加する]]
=== カスタムスロットタイプを追加する
. スキルビルダーを開き、左側のパネルからスロット値の「追加」ボタンをクリックします。
+
image::EX3/Slot_Data.png[]
+
. カスタムスロットタイプ名をMenuListにして、「カスタムスロットタイプを作成」ボタンをクリックします。
+
image::EX3/Create_Custom_SlotType.png[]
+
. スロット値を入力する画面が開きます。コーヒーショップで選択できるメニュー品目のリストを追加します。ここでは「コーヒー」「カフェオレ」「カプチーノ」「エスプレッソ」の4つを追加しましょう。追加が終わったら「モデルを保存」ボタンをクリックしておきます。
+
image::EX3/Save_Model.png[]
+
. インテント OrderIntentの編集画面を表示し、既に登録されているサンプル発話の「コーヒー」と書かれている部分をマウスで選択します。
+
image::EX3/Add_Menu_Slot.png[]
+
. 新しいスロットを作成のテキストフィールドに、追加するスロット名menuを入力し、「追加」ボタンをクリックします。
+
image::EX3/Name_SlotType.png[]
+
. 下方のインテントスロットを確認します。2行目を1クリックすると新しいスロットmenuが表示されます。スロットmenuのスロットタイプ MenuListをスロットタイプのリストから選択します。
+
image::EX3/Select_Menu_Slot.png[]
+
. 他の既存のサンプル発話の「コーヒー」の部分を全てスロットmenuに置き換えましょう。手順は同様で既存のスロットの選択リストにmenuが追加されているはずです。
+
image::EX3/Select_MenuList.png[]
+
. 全ての「コーヒー」をスロットmenuに置き換えたら、「モデルを保存」ボタンと「モデルをビルド」ボタンを順にクリックしましょう。
+
image::EX3/Save_And_Build2.png[]

以上で、対話モデルの修正は完了です。次にLambda関数の修正に移りましょう。

[[課題3_Lambdaのコードを改良する]]
== Lambdaのコードを改良する

スロットmenuの値を受け取れるようにLambda側のプログラムコードも修正しましょう。
プログラミングに自信のない方は、Lambdaの *indes.js* をサンプルファイル <<Sample3.js>> の中身をコピーして貼り付けてください。

image::EX3/Sample3_JS.png[]

自分でコードを書いてみたい方は、以下のコードをヒントに、既存のコードに修正を加えてください。

[source,javascript,linenums]
.スロット menu の値を取得し、menuの値を含めた応答を返すコード
----
var amount = handlerInput.requestEnvelope.request.intent.slots.amount.value;
var menu = handlerInput.requestEnvelope.request.intent.slots.menu.value;

const speechOutput = menu + 'を' + amount + 'つですね、ありがとうございます。今日は天気がいいので全部100円でいいですよ。またの御利用をお待ちしております。';

return handlerInput.responseBuilder
.speak(speechOutput)
.getResponse();
----

CAUTION: ユーザーは欲しい品目を言ってくれない場合もあります。例えば「アレクサ、コーヒーショップで一つ注文して」のような場合です（このサンプル発話も追加しておく必要があります）。この場合、何を注文したいのかユーザーに聞き返す処理が必要で、そのコードは次のように書くことができます。この処理もコードに追加しておきましょう。

[source,javascript,linenums]
.ユーザーが欲しい商品を言ってくれなかった場合の判別と、ユーザーに尋ねるコード
----
if (menu === undefined){
    const speechOutput = 'コーヒー、カフェラテ、カプチーノからお選びいただけます。どれにしますか？';
    const reprompt = '何にしますか？';
    return handlerInput.responseBuilder
    .speak(speechOutput)
    .reprompt(reprompt)
    .getResponse();
}
----

Lambda関数のコードの修正が完了したら「保存」ボタンをクリックしてテストしましょう。

[[テスト3]]
== テストする

対話モデル及びLambda関数の修正が終わったらスロットの値が正しく取得できるかどうかテストしましょう。
Alexaシミュレータを開き、「コーヒーショップを開いて、**カプチーノ**を**一つ**注文して」のようにスロットを含めた発話を入力してテストしてみましょう。タイプ入力だけではなく、音声入力でもテストを繰り返し、スロットの値が正しく取得できているかを確認しましょう。

image::EX3/JSON_Input_MenuSlot.png[]

ここまでくると、ずいぶん実用に近いスキルになってきました。対話モデルやLambdaコードを微調整し完成度を高めましょう。

以上で課題3は終了です。お疲れ様でした！
