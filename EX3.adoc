= スロットの使用
:imagesdir: ./images

== この実習の学習目標

この実習ではユーザーの発話から *ドリンクのメニュー* と *ドリンクの数* の情報を受け取るようにスキルを改良します。

この実習で学んだテクニックを使うと次のようなことができるようになります。

* 対話モデルのサンプル発話にスロットを導入する手順を実演できる
* 標準スロットタイプとカスタムスロットタイプを使い分けることができる。
* スロットで受け取ったデータがどのようにエンドポイントに渡されるかを説明できる。

== 対話モデルの編集
.スキルの会話サンプル
====
image:icons/user_speak.jpg[width="40"]「アレクサ、コーヒーショップを開いて、**カフェラテ**を**二つ**ください」

image:icons/alexa_icon.jpg[width="40"] 「**カフェラテ**を**2つ**ですね、ありがとうございます。今日は天気がいいので全部100円でいいですよ。またのご利用をお待ちしております。」
====

[TIP]
====
* サンプル発話に「スロット」を追加し、エンドポイントでインテントと共にスロットの値を受け取れるようにします。
====

.参考ドキュメント
[NOTE]
====
* https://developer.amazon.com/ja/docs/custom-skills/create-intents-utterances-and-slots.html[インテント、発話、スロットの作成]
* https://developer.amazon.com/ja/docs/custom-skills/slot-type-reference.html[スロットタイプリファレンス]
* https://developer.amazon.com/ja/docs/custom-skills/create-and-edit-custom-slot-types.html[カスタムスロットタイプの作成と編集]
====

image:icons/alexa_dojo.png[width="40"]  https://alexa.design/jp-alexadojo005[第5回 Alexa道場：スロットを使って発話内の可変文字列を取得しよう]

=== スロットを追加する
. 開発者コンソールに戻りスキルビルダーを開きます。
. インテント「*OrderIntent*」をクリックします。
. スロットを含むサンプル発話を追加します。まず「コーヒーを一つ注文して」と入力します。
+
image::EX3/OrderIntent.png[]
+
. スロットにしたい部分「一」（漢数字の1）マウスで選択します。下図のようなスロットを追加するポップアップが表示されます。
+
image::EX3/Add_New_Slot.png[]
+
. 新しいスロットを作成のテキストフィールドに、追加したいスロット名「amount」を入力しましょう。スロット名は必ず半角英文字で入力します。入力したら「追加」ボタンをクリックします。
+
image::EX3/Add_Amount_Slot.png[]
+
. スロットを含むサンプル発話に置き換えられています。＋ボタンか、リターンキーを押して確定します。
+
image::EX3/Amount_Slot.png[]
+
. 画面の下の方を見ると、インテントスロットにamountが追加されていることが確認できます。amountのスロットタイプを設定しましょう。この場合「数値」を取得するので、標準スロットタイプのAMAZON.NUMBERを選択します。
+
image::EX3/SlotType_AMAZON_Number.png[]
+
=== カスタムスロットタイプを追加する
. 左のパネルからスロットタイプの「追加」ボタンをクリックします。
+
image::EX3/Add_CustomSlotType.png[]
+
. カスタムスロットタイプ名を **MenuList** にして、「カスタムスロットタイプを作成」ボタンをクリックします。
+
image::EX3/Create_Custom_SlotType.png[]
+
. スロット値を入力する画面が開きます。コーヒーショップで選択できるメニュー品目のリストを追加します。ここでは「コーヒー」「カフェオレ」「カプチーノ」「エスプレッソ」の4つを追加しましょう。追加が終わったら「モデルを保存」ボタンをクリックしておきます。
+
image::EX3/Save_Model.png[]
+
. インテント OrderIntentの編集画面を表示し、既に登録されているサンプル発話の「コーヒー」と書かれている部分をマウスで選択します。
+
image::EX3/Add_Menu_Slot.png[]
+
. 新しいスロットを作成のテキストフィールドに、追加するスロット名menuを入力し、「追加」ボタンをクリックします。
+
image::EX3/Menu_Slot.png[]
+
. 下方のインテントスロットを確認します。2行目を1クリックすると新しいスロットmenuが表示されます。スロットmenuのスロットタイプ **MenuList** をスロットタイプのリストから選択します。
+
image::EX3/Select_MenuList_SlotType.png[]
+
. 他の既存のサンプル発話の「コーヒー」の部分もスロットmenuに置き換えます。
+
image::EX3/Select_MenuList.png[]
+
. 全ての「コーヒー」をスロットmenuに置き換えたら、「モデルを保存」ボタンと「モデルをビルド」ボタンを順にクリックしましょう。
+
image::EX3/Save_And_Build2.png[]

以上で、対話モデルの修正は完了です。次にLambda関数の修正に移りましょう。

== Lambdaのコードを改良する

スロットmenuの値を受け取れるようにLambda側のプログラムコードも修正しましょう。

[NOTE]
プログラミングに自信のない方は、Lambdaの *index.js* のコードをサンプルファイル <<Sample3.js>> のコードに置き換えてください。

[source,javascript]
.スロット menu と amount の値を取得し、それぞれの値を含めた応答を返すコード
----
var amount = handlerInput.requestEnvelope.request.intent.slots.amount.value;
var menu = handlerInput.requestEnvelope.request.intent.slots.menu.value;

const speechOutput = menu + 'を' + amount + 'つですね、ありがとうございます。今日は天気がいいので全部100円でいいですよ。またの御利用をお待ちしております。';

return handlerInput.responseBuilder
.speak(speechOutput)
.getResponse();
----

Lambda関数のコードの修正が完了したら「保存」ボタンをクリックしてテストしましょう。

== テストする

対話モデル及びLambda関数の修正が終わったらスロットの値が正しく取得できるかどうかテストしましょう。

. Alexaシミュレータを開き、「`コーヒーショップを開いて、コーヒーを一つ注文して`」のようにスロットを含めた発話を入力してテストしてみましょう。このとき、スロットに数字を入れる場合は、漢数字で入れてください。半角や全角の数字はうまく認識しないので注意してください。タイプ入力だけではなく、音声入力でもテストを繰り返し、スロットの値が正しく取得できているかを確認しましょう。
+
image::EX3/Sample_Utterances.png[]
+
. JSON入力で、スロットの値が正しく取得できているかどうかを観察します。下図のようにスロット名 *menu* にユーザーが発話したメニューの名前（下図の場合は **コーヒー**）、 *amount* に数（下図の場合は数字の **2** ）が入ることを確認します。
+
image::EX3/JSON_Input_Slot_Menu_Amount.png[]
+
. JSON出力側も正しく数字の入った応答を返しているかを確認しましょう。
